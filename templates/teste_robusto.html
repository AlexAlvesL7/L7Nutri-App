<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üõ°Ô∏è Teste de Cadastro Robusto - L7Nutri</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            color: #2d3748;
            margin-bottom: 10px;
        }
        .header p {
            color: #718096;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #2d3748;
            font-weight: 600;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: transform 0.2s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        .btn-primary:disabled {
            opacity: 0.6;
            transform: none;
            cursor: not-allowed;
        }
        .log-area {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
        .log-success { color: #48bb78; }
        .log-error { color: #f56565; }
        .log-warning { color: #ed8936; }
        .log-info { color: #4299e1; }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
            font-weight: 600;
        }
        .status-success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #48bb78;
        }
        .status-error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #f56565;
        }
        .status-info {
            background: #bee3f8;
            color: #2a4365;
            border: 1px solid #4299e1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è Teste de Cadastro Robusto</h1>
            <p>Sistema de preven√ß√£o e detec√ß√£o de erros de API</p>
        </div>

        <form id="cadastroForm">
            <div class="form-group">
                <label for="nome">Nome Completo:</label>
                <input type="text" id="nome" name="nome" value="Usu√°rio Teste Sistema" required>
            </div>

            <div class="form-group">
                <label for="email">E-mail:</label>
                <input type="email" id="email" name="email" value="teste.sistema@exemplo.com" required>
            </div>

            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" value="testesistema2025" required>
            </div>

            <div class="form-group">
                <label for="password">Senha:</label>
                <input type="password" id="password" name="password" value="senha123456" required>
            </div>

            <button type="submit" class="btn-primary" id="btnCadastrar">
                üöÄ Testar Cadastro Robusto
            </button>
        </form>

        <div id="status" class="status" style="display: none;"></div>
        
        <div class="log-area" id="logArea">
            <div class="log-info">üìã Sistema pronto para teste. Clique em "Testar Cadastro Robusto" para come√ßar.</div>
        </div>

        <div style="margin-top: 20px; text-align: center;">
            <button onclick="testarConectividade()" class="btn-primary" style="width: auto; margin-right: 10px;">
                üß™ Testar Conectividade
            </button>
            <button onclick="limparLogs()" class="btn-primary" style="width: auto; background: #718096;">
                üßπ Limpar Logs
            </button>
        </div>
    </div>

    <script>
        // Incluir o ApiHandler robusto
        /**
         * üõ°Ô∏è API HANDLER ROBUSTO - L7NUTRI
         * Previne e detecta erros de API com tratamento completo
         */
        class ApiHandler {
            constructor(baseUrl = '') {
                this.baseUrl = baseUrl;
            }

            async request(endpoint, options = {}) {
                const url = this.baseUrl + endpoint;
                
                const config = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                };

                this.log(`üöÄ API Request: ${config.method} ${url}`, 'info');
                
                try {
                    const response = await fetch(url, config);
                    
                    // Verifica√ß√£o 1: Status HTTP
                    if (!response.ok) {
                        const errorText = await response.text();
                        this.log(`‚ùå HTTP Error ${response.status}: ${errorText.substring(0, 200)}`, 'error');
                        
                        // Detecta se retornou HTML em vez de JSON
                        if (errorText.includes('<!DOCTYPE') || errorText.includes('<html')) {
                            this.log('üö® ERRO CR√çTICO: Servidor retornou HTML em vez de JSON!', 'error');
                            this.log('üí° Poss√≠veis causas: Erro 500, 502, ou problema de inicializa√ß√£o', 'warning');
                            throw new Error(`Erro do servidor (${response.status}): Sistema pode estar com problemas de banco de dados ou modelos`);
                        }
                        
                        throw new Error(`Erro HTTP ${response.status}: ${errorText}`);
                    }

                    // Verifica√ß√£o 2: Content-Type
                    const contentType = response.headers.get('content-type');
                    if (!contentType || !contentType.includes('application/json')) {
                        const responseText = await response.text();
                        this.log(`üö® ERRO: Esperado JSON mas recebeu: ${contentType}`, 'error');
                        this.log(`üìÑ Conte√∫do: ${responseText.substring(0, 200)}...`, 'warning');
                        
                        if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                            this.log('üí• ERRO CR√çTICO: P√°gina HTML retornada em resposta JSON!', 'error');
                            throw new Error('Erro cr√≠tico do servidor: Sistema retornou p√°gina de erro em vez de dados JSON');
                        }
                        
                        throw new Error(`Resposta inv√°lida: esperado JSON, recebido ${contentType}`);
                    }

                    // Sucesso: Parse JSON
                    const data = await response.json();
                    this.log(`‚úÖ API Success: ${config.method} ${url}`, 'success');
                    this.log(`üì¶ Dados recebidos: ${JSON.stringify(data).substring(0, 200)}...`, 'success');
                    return data;

                } catch (error) {
                    this.log(`üí• API Error: ${config.method} ${url} - ${error.message}`, 'error');
                    
                    // Diagn√≥stico avan√ßado
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        this.log('üåê ERRO DE REDE: Servidor pode estar offline ou com problemas de conectividade', 'error');
                        throw new Error('Erro de conectividade: Verifique sua internet ou se o servidor est√° online');
                    }
                    
                    if (error.message.includes('SyntaxError') && error.message.includes('JSON')) {
                        this.log('üìù ERRO DE PARSING JSON: Resposta do servidor n√£o √© JSON v√°lido', 'error');
                        throw new Error('Erro de dados: Servidor retornou dados corrompidos');
                    }
                    
                    throw error;
                }
            }

            async post(endpoint, data) {
                return this.request(endpoint, {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            async get(endpoint) {
                return this.request(endpoint, { method: 'GET' });
            }

            log(message, type = 'info') {
                const logArea = document.getElementById('logArea');
                const timestamp = new Date().toLocaleTimeString();
                const logClass = `log-${type}`;
                const logEntry = `<div class="${logClass}">[${timestamp}] ${message}</div>`;
                logArea.innerHTML += logEntry;
                logArea.scrollTop = logArea.scrollHeight;
                console.log(`[${type.toUpperCase()}] ${message}`);
            }
        }

        // Inst√¢ncia global
        const api = new ApiHandler();

        // Fun√ß√£o de cadastro com diagn√≥stico
        async function cadastrarUsuarioSeguro(dadosUsuario) {
            try {
                api.log('üìù Iniciando cadastro seguro...', 'info');
                api.log(`üìã Dados: ${JSON.stringify(dadosUsuario)}`, 'info');
                
                // Valida√ß√£o pr√©via
                if (!dadosUsuario.nome || !dadosUsuario.email || !dadosUsuario.username || !dadosUsuario.password) {
                    throw new Error('Dados obrigat√≥rios n√£o fornecidos: nome, email, username, password');
                }
                
                const resultado = await api.post('/api/cadastro', dadosUsuario);
                
                api.log('üéâ Cadastro realizado com sucesso!', 'success');
                api.log(`‚úÖ Resultado: ${JSON.stringify(resultado)}`, 'success');
                return resultado;
                
            } catch (error) {
                api.log(`üí• Erro no cadastro: ${error.message}`, 'error');
                
                // Diagn√≥stico espec√≠fico
                if (error.message.includes('500')) {
                    api.log('üîç DIAGN√ìSTICO: Erro 500 pode indicar:', 'warning');
                    api.log('   1. Problema de banco de dados (coluna inexistente)', 'warning');
                    api.log('   2. Erro nos modelos SQLAlchemy', 'warning');
                    api.log('   3. Problema de relacionamentos (Foreign Key)', 'warning');
                    api.log('üí° Sugest√£o: Verificar logs do servidor para detalhes espec√≠ficos', 'info');
                }
                
                if (error.message.includes('400')) {
                    api.log('üîç DIAGN√ìSTICO: Erro 400 pode indicar:', 'warning');
                    api.log('   1. Dados obrigat√≥rios faltando', 'warning');
                    api.log('   2. Formato de dados incorreto', 'warning');
                    api.log('   3. Valida√ß√£o falhou no backend', 'warning');
                }
                
                throw error;
            }
        }

        // Fun√ß√£o de teste de conectividade
        async function testarConectividade() {
            try {
                api.log('üß™ Testando conectividade da API...', 'info');
                
                // Teste b√°sico
                const resultado = await api.get('/api/teste');
                api.log('‚úÖ API b√°sica funcionando!', 'success');
                
                // Teste de diagn√≥stico
                try {
                    const diagnostico = await api.get('/api/teste-tabelas');
                    api.log('‚úÖ Diagn√≥stico de tabelas funcionando!', 'success');
                } catch (diagError) {
                    api.log(`‚ö†Ô∏è Endpoint de diagn√≥stico indispon√≠vel: ${diagError.message}`, 'warning');
                }
                
                showStatus('Conectividade testada com sucesso!', 'success');
                return true;
                
            } catch (error) {
                api.log(`‚ùå Falha na conectividade: ${error.message}`, 'error');
                showStatus('Falha na conectividade!', 'error');
                return false;
            }
        }

        // Manipula√ß√£o do formul√°rio
        document.getElementById('cadastroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const btnCadastrar = document.getElementById('btnCadastrar');
            btnCadastrar.disabled = true;
            btnCadastrar.textContent = '‚è≥ Testando...';
            
            try {
                const formData = new FormData(this);
                const dadosUsuario = {
                    nome: formData.get('nome'),
                    email: formData.get('email'),
                    username: formData.get('username'),
                    password: formData.get('password')
                };
                
                const resultado = await cadastrarUsuarioSeguro(dadosUsuario);
                showStatus('Cadastro realizado com sucesso!', 'success');
                
            } catch (error) {
                api.log(`üö® Erro final: ${error.message}`, 'error');
                showStatus(`Erro no cadastro: ${error.message}`, 'error');
            } finally {
                btnCadastrar.disabled = false;
                btnCadastrar.textContent = 'üöÄ Testar Cadastro Robusto';
            }
        });

        // Utilit√°rios
        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status status-${type}`;
            statusDiv.style.display = 'block';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        function limparLogs() {
            document.getElementById('logArea').innerHTML = '<div class="log-info">üìã Logs limpos. Sistema pronto para novo teste.</div>';
        }

        // Log inicial
        api.log('üõ°Ô∏è Sistema de teste robusto carregado!', 'success');
        api.log('üí° Este sistema detecta e diagn√≥stica automaticamente problemas de API', 'info');
    </script>
</body>
</html>
